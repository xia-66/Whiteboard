<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>åœ¨çº¿ç™½æ¿</title>
  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --text: #1f2937;
      --sub: #6b7280;
      --primary: #2563eb;
      --danger: #dc2626;
      --ok: #16a34a;
      --border: #cbd5e1;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .app {
      width: 100%;
      min-height: 100vh;
      background: var(--card);
      border: 0;
      border-radius: 0;
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    .title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .desc {
      color: var(--sub);
      font-size: 13px;
      margin-bottom: 12px;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    button {
      border: 1px solid var(--border);
      background: #f9fafb;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { filter: brightness(1.1); }
    #pasteBtn {
      background: #60a5fa;
      border-color: transparent;
      color: #fff;
    }
    .primary { background: var(--primary); border-color: transparent; }
    .danger { background: var(--danger); border-color: transparent; }
    .ok { background: var(--ok); border-color: transparent; }
    .primary, .danger, .ok { color: #fff; }

    textarea {
      width: 100%;
      min-height: 0;
      height: calc(100vh - 220px);
      resize: vertical;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 14px;
      line-height: 1.6;
      font-size: 15px;
      outline: none;
    }
    .status {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      color: var(--sub);
      font-size: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tip {
      margin-top: 8px;
      font-size: 12px;
      color: var(--sub);
    }
    kbd {
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-bottom-width: 2px;
      border-radius: 6px;
      padding: 0 6px;
      font-size: 12px;
    }

    @media (max-width: 768px) {
      .app { padding: 12px; }
      .title { font-size: 18px; }
      .desc, .tip, .status { font-size: 12px; }
      .toolbar { gap: 6px; }
      button {
        flex: 1 1 calc(50% - 6px);
        min-height: 40px;
        padding: 8px;
      }
      textarea {
        height: calc(100vh - 250px);
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      button {
        flex-basis: 100%;
      }
      .status {
        flex-direction: column;
        gap: 4px;
      }
      textarea {
        height: calc(100vh - 300px);
      }
    }
  </style>
</head>
<body>
  <main class="app">
    <div class="title">ğŸ“ åœ¨çº¿ç™½æ¿ </div>
    <div class="desc">ç”¨äºä¸´æ—¶ä¿å­˜æ–‡æœ¬ã€ä»£ç ã€é“¾æ¥ã€‚å†…å®¹è‡ªåŠ¨ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ï¼Œä¸ä¸Šä¼ æœåŠ¡å™¨ã€‚</div>

    <div class="toolbar">
      <button id="pasteBtn">ä»å‰ªè´´æ¿ç²˜è´´</button>
      <button id="copyBtn" class="primary">å¤åˆ¶å…¨éƒ¨</button>
      <button id="downloadBtn" class="ok">å¯¼å‡º TXT</button>
      <button id="clearBtn" class="danger">æ¸…ç©º</button>
    </div>

    <textarea id="board" placeholder="æŠŠå†…å®¹ç²˜è´´åˆ°è¿™é‡Œâ€¦"></textarea>

    <div class="status">
      <span id="stat">å­—æ•°: 0 ï½œ è¡Œæ•°: 1</span>
      <span id="saveState">çŠ¶æ€ï¼šæœªä¿®æ”¹</span>
    </div>

    <div class="tip">
      å¿«æ·é”®ï¼š<kbd>Ctrl/Cmd + S</kbd> æ‰‹åŠ¨ä¿å­˜ï¼ˆå…¶å®ä¼šè‡ªåŠ¨ä¿å­˜ï¼‰ï½œ
      <kbd>Ctrl/Cmd + A</kbd> å…¨é€‰ï½œ
      <kbd>Ctrl/Cmd + C</kbd> å¤åˆ¶
    </div>
  </main>

  <script>
    const board = document.getElementById('board');
    const stat = document.getElementById('stat');
    const saveState = document.getElementById('saveState');

    const pasteBtn = document.getElementById('pasteBtn');
    const copyBtn = document.getElementById('copyBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const STORAGE_KEY = 'temp_whiteboard_content_v1';
    const TIME_KEY = 'temp_whiteboard_saved_at_v1';

    // åˆå§‹åŒ–è¯»å–æœ¬åœ°ç¼“å­˜
    const cached = localStorage.getItem(STORAGE_KEY);
    if (cached) board.value = cached;
    updateStat();

    function nowText() {
      const d = new Date();
      const p = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }

    let saveTimer = null;
    function scheduleSave() {
      saveState.textContent = 'çŠ¶æ€ï¼šç¼–è¾‘ä¸­...';
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        localStorage.setItem(STORAGE_KEY, board.value);
        localStorage.setItem(TIME_KEY, nowText());
        saveState.textContent = `çŠ¶æ€ï¼šå·²ä¿å­˜ï¼ˆ${localStorage.getItem(TIME_KEY)}ï¼‰`;
      }, 300);
    }

    function updateStat() {
      const text = board.value || '';
      const chars = text.length;
      const lines = text.length ? text.split('\n').length : 1;
      stat.textContent = `å­—æ•°: ${chars} ï½œ è¡Œæ•°: ${lines}`;
    }

    function syncStatAndSave() {
      updateStat();
      scheduleSave();
    }

    // ä¸åŒè¾“å…¥æ³• / æµè§ˆå™¨ä¸‹éƒ½èƒ½ç¨³å®šæ›´æ–°å­—æ•°
    ['input', 'change', 'keyup', 'paste', 'cut', 'drop', 'compositionend'].forEach((evt) => {
      board.addEventListener(evt, syncStatAndSave);
    });

    // ç²˜è´´æŒ‰é’®
    pasteBtn.addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (!text) return alert('å‰ªè´´æ¿ä¸ºç©º');
        // å…‰æ ‡ä½ç½®æ’å…¥
        const start = board.selectionStart ?? board.value.length;
        const end = board.selectionEnd ?? board.value.length;
        board.value = board.value.slice(0, start) + text + board.value.slice(end);
        board.selectionStart = board.selectionEnd = start + text.length;
        board.focus();
        updateStat();
        scheduleSave();
      } catch (e) {
        alert('è¯»å–å‰ªè´´æ¿å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ Ctrl/Cmd+V ç²˜è´´ã€‚\nï¼ˆæµè§ˆå™¨éœ€ HTTPS æˆ– localhostï¼‰');
      }
    });

    // å¤åˆ¶æŒ‰é’®
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(board.value);
        copyBtn.textContent = 'å·²å¤åˆ¶ âœ…';
        setTimeout(() => (copyBtn.textContent = 'å¤åˆ¶å…¨éƒ¨'), 1200);
      } catch (e) {
        // å…¼å®¹è€æ–¹å¼
        board.select();
        document.execCommand('copy');
        copyBtn.textContent = 'å·²å¤åˆ¶ âœ…';
        setTimeout(() => (copyBtn.textContent = 'å¤åˆ¶å…¨éƒ¨'), 1200);
      }
    });

    // æ¸…ç©ºæŒ‰é’®
    clearBtn.addEventListener('click', () => {
      if (!confirm('ç¡®å®šæ¸…ç©ºç™½æ¿å†…å®¹å—ï¼Ÿ')) return;
      board.value = '';
      updateStat();
      localStorage.removeItem(STORAGE_KEY);
      localStorage.removeItem(TIME_KEY);
      saveState.textContent = 'çŠ¶æ€ï¼šå·²æ¸…ç©º';
      board.focus();
    });

    // å¯¼å‡º TXT
    downloadBtn.addEventListener('click', () => {
      const blob = new Blob([board.value], { type: 'text/plain;charset=utf-8' });
      const a = document.createElement('a');
      const ts = nowText().replace(/[: ]/g, '-');
      a.href = URL.createObjectURL(blob);
      a.download = `whiteboard-${ts}.txt`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Ctrl/Cmd + S
    window.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 's') {
        e.preventDefault();
        localStorage.setItem(STORAGE_KEY, board.value);
        localStorage.setItem(TIME_KEY, nowText());
        saveState.textContent = `çŠ¶æ€ï¼šå·²æ‰‹åŠ¨ä¿å­˜ï¼ˆ${localStorage.getItem(TIME_KEY)}ï¼‰`;
      }
    });

    // åˆå§‹çŠ¶æ€
    const t = localStorage.getItem(TIME_KEY);
    saveState.textContent = t ? `çŠ¶æ€ï¼šå·²åŠ è½½ï¼ˆä¸Šæ¬¡ä¿å­˜ ${t}ï¼‰` : 'çŠ¶æ€ï¼šæœªä¿®æ”¹';
  </script>
</body>
</html>